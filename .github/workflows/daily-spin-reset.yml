name: Daily Spin Tasks

on:
  schedule:
    # Runs at 00:00 UTC (5:30 AM IST) for reset
    - cron: '0 0 * * *'
    # Runs at 14:00 UTC (7:30 PM IST) for notifications
    - cron: '0 14 * * *'
  workflow_dispatch:

jobs:
  daily-tasks:
    runs-on: ubuntu-latest
    env:
      DEEP_LINK: "aviders://spinwheel"
      APP_NAME: "Aviders Spin Wheel"
      BACKEND_URL: "https://aviders-backend-spin-1.onrender.com"
      
    steps:
      - name: Debug Workflow Trigger
        run: |
          echo "üöÄ Workflow Trigger: ${{ github.event_name }}"
          echo "üìÖ UTC Time: $(date -u)"
          echo "üìÖ IST Time: $(TZ='Asia/Kolkata' date)"
          echo "üîß GitHub Ref: ${{ github.ref }}"
          echo "üë§ GitHub Actor: ${{ github.actor }}"
          
      - name: Check Secrets Availability
        run: |
          echo "üîê Checking secrets availability..."
          if [ -z "${{ secrets.SPIN_INTERNAL_KEY }}" ]; then
            echo "‚ùå SPIN_INTERNAL_KEY secret is empty!"
          else
            echo "‚úÖ SPIN_INTERNAL_KEY secret is available"
            echo "Key length: ${#SPIN_INTERNAL_KEY} characters"
          fi
          
      - name: Determine Scheduled Task
        id: schedule
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          
          echo "üïê UTC Time: $HOUR:$MINUTE"
          echo "üîÑ GitHub Event: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Scheduled run - check which cron triggered it
            if [ "$HOUR" = "00" ] && [ "$MINUTE" = "00" ]; then
              echo "TASK=reset" >> $GITHUB_OUTPUT
              echo "TASK_NAME=midnight_reset" >> $GITHUB_OUTPUT
              echo "üéØ Scheduled: DAILY RESET (00:00 UTC)"
            elif [ "$HOUR" = "14" ] && [ "$MINUTE" = "00" ]; then
              echo "TASK=notify" >> $GITHUB_OUTPUT
              echo "TASK_NAME=afternoon_notification" >> $GITHUB_OUTPUT
              echo "üéØ Scheduled: DAILY NOTIFICATION (14:00 UTC)"
            else
              echo "TASK=unknown_schedule" >> $GITHUB_OUTPUT
              echo "TASK_NAME=unknown" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Unexpected schedule time: $HOUR:$MINUTE"
            fi
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - run BOTH tasks
            echo "TASK=both" >> $GITHUB_OUTPUT
            echo "TASK_NAME=manual_full_run" >> $GITHUB_OUTPUT
            echo "üéØ Manual Trigger: Running BOTH reset and notify"
          else
            echo "TASK=other" >> $GITHUB_OUTPUT
            echo "TASK_NAME=other_trigger" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Other trigger type: ${{ github.event_name }}"
          fi
          
      - name: Reset Daily Spins (00:00 UTC or Manual)
        id: reset_spins
        if: steps.schedule.outputs.TASK == 'reset' || steps.schedule.outputs.TASK == 'both'
        run: |
          echo "üîÑ RESETTING DAILY SPINS..."
          echo "‚è∞ Time: $(date -u)"
          echo "üåê Backend: $BACKEND_URL"
          
          # Test backend connection first
          echo "üîç Testing backend connection..."
          if curl -s --head --request GET "$BACKEND_URL" | grep "200 OK"; then
            echo "‚úÖ Backend is reachable"
          else
            echo "‚ö†Ô∏è Backend might be sleeping (Render free tier)"
          fi
          
          # Call reset API
          echo "üì§ Calling reset API..."
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "$BACKEND_URL/api/spin/admin/reset-daily" \
            -H "Content-Type: application/json" \
            -H "x-internal-key: ${{ secrets.SPIN_INTERNAL_KEY }}" \
            -d '{}')
          
          # Extract response
          HTTP_STATUS=$(echo "$RESPONSE" | grep HTTP_STATUS | cut -d':' -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
          
          echo "üìä Reset Response Status: $HTTP_STATUS"
          echo "üìÑ Reset Response Body: $RESPONSE_BODY"
          
          if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "201" ]]; then
            echo "‚úÖ DAILY SPINS RESET SUCCESSFUL!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå RESET FAILED! Status: $HTTP_STATUS"
            echo "üîç Response: $RESPONSE_BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Prepare Notification Payload
        id: prepare_notify
        if: steps.schedule.outputs.TASK == 'notify' || steps.schedule.outputs.TASK == 'both'
        run: |
          echo "üìù PREPARING NOTIFICATION..."
          
          TIMESTAMP=$(date +%s)
          NOTIFICATION_ID="daily_spin_$(date +%Y%m%d_%H%M%S)"
          
          # Create payload
          cat > /tmp/notification_payload.json << EOF
          {
            "notification": {
              "title": "üé° Daily Spin Ready!",
              "body": "Spin now and claim your reward!",
              "click_action": "$DEEP_LINK"
            },
            "data": {
              "deeplink": "$DEEP_LINK",
              "action": "open_spinwheel",
              "notification_id": "$NOTIFICATION_ID",
              "timestamp": "$TIMESTAMP"
            }
          }
          EOF
          
          echo "üìÑ Payload created:"
          cat /tmp/notification_payload.json
          
          echo "payload_file=/tmp/notification_payload.json" >> $GITHUB_OUTPUT
          echo "notification_id=$NOTIFICATION_ID" >> $GITHUB_OUTPUT
          
      - name: Send Notifications (14:00 UTC or Manual)
        id: send_notify
        if: steps.schedule.outputs.TASK == 'notify' || steps.schedule.outputs.TASK == 'both'
        run: |
          echo "üì± SENDING NOTIFICATIONS..."
          echo "üîë Using secret key with length: ${#SPIN_INTERNAL_KEY}"
          
          # Test backend connection
          echo "üîç Testing backend connection..."
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL")
          echo "Backend status: $BACKEND_STATUS"
          
          if [ "$BACKEND_STATUS" != "200" ]; then
            echo "‚ö†Ô∏è Backend might be sleeping. Waking it up..."
            curl -s -o /dev/null "$BACKEND_URL" && sleep 10
          fi
          
          # Send notification via backend
          echo "üì§ Sending to: $BACKEND_URL/api/spin/admin/run-notify"
          
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "$BACKEND_URL/api/spin/admin/run-notify" \
            -H "Content-Type: application/json" \
            -H "x-internal-key: ${{ secrets.SPIN_INTERNAL_KEY }}" \
            -d @${{ steps.prepare_notify.outputs.payload_file }})
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep HTTP_STATUS | cut -d':' -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
          
          echo "üìä Notification Response Status: $HTTP_STATUS"
          echo "üìÑ Notification Response Body: $RESPONSE_BODY"
          
          if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "201" ]]; then
            echo "‚úÖ NOTIFICATIONS SENT SUCCESSFULLY!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå NOTIFICATION FAILED! Status: $HTTP_STATUS"
            echo "üîç Troubleshooting tips:"
            echo "1. Check if SPIN_INTERNAL_KEY secret is correct"
            echo "2. Verify backend is running"
            echo "3. Check backend logs for 'Internal access denied'"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Workflow Summary
        run: |
          echo ""
          echo "üìã WORKFLOW SUMMARY"
          echo "=================="
          echo "Trigger: ${{ github.event_name }}"
          echo "Task: ${{ steps.schedule.outputs.TASK_NAME }}"
          echo "Time: $(date -u)"
          echo ""
          
          if [ "${{ steps.schedule.outputs.TASK }}" = "reset" ]; then
            echo "‚úÖ Reset executed: ${{ steps.reset_spins.outputs.success }}"
            echo "üîî Notification: Skipped (runs at 14:00 UTC)"
          elif [ "${{ steps.schedule.outputs.TASK }}" = "notify" ]; then
            echo "üîÑ Reset: Skipped (runs at 00:00 UTC)"
            echo "‚úÖ Notification executed: ${{ steps.send_notify.outputs.success }}"
          elif [ "${{ steps.schedule.outputs.TASK }}" = "both" ]; then
            echo "‚úÖ Reset executed: ${{ steps.reset_spins.outputs.success }}"
            echo "‚úÖ Notification executed: ${{ steps.send_notify.outputs.success }}"
          fi
          
          echo ""
          echo "‚è∞ Next Scheduled Runs:"
          echo "  ‚Ä¢ Daily Reset: 00:00 UTC (5:30 AM IST)"
          echo "  ‚Ä¢ Notification: 14:00 UTC (7:30 PM IST)"
          echo ""
          echo "üîó Deep Link: $DEEP_LINK"
          
      - name: Alert on Failure
        if: failure()
        run: |
          echo "üö® WORKFLOW FAILED!"
          echo "Please check:"
          echo "1. GitHub Secrets (SPIN_INTERNAL_KEY)"
          echo "2. Backend server status"
          echo "3. Backend logs for errors"
