name: Daily Spin Tasks (Reset + Notify)

on:
  workflow_dispatch:   # manual trigger
  schedule:
    - cron: "30 0 * * *"   # runs daily at 00:30 UTC (~06:00 IST)

jobs:
  daily-spin-tasks:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 1Ô∏è‚É£ Validate Secret & Backend
      # -------------------------
      - name: Validate Secret and Backend
        id: validate
        run: |
          echo "üîê Checking SPIN_INTERNAL_KEY..."

          if [ -z "${{ secrets.SPIN_INTERNAL_KEY }}" ]; then
            echo "‚ùå SPIN_INTERNAL_KEY not set"
            exit 1
          fi

          echo "‚úÖ Secret found"

          echo "üåç Testing backend health..."
          curl -s -o /dev/null -w "Health status: %{http_code}\n" \
            https://aviders-backend-spin-1.onrender.com

      # -------------------------
      # 2Ô∏è‚É£ Reset Daily Free Spins
      # -------------------------
      - name: Reset Daily Free Spins
        run: |
          echo "üîÑ Resetting daily free spins..."

          curl -X POST https://aviders-backend-spin-1.onrender.com/api/spin/admin/reset-daily \
            -H "Content-Type: application/json" \
            -H "x-internal-key: ${{ secrets.SPIN_INTERNAL_KEY }}" \
            -d '{}' \
            -w "\nHTTP Status: %{http_code}\n"

          echo "‚úÖ Daily spin reset completed"

      # -------------------------
      # 3Ô∏è‚É£ Send FCM Notifications
      # -------------------------
      - name: Send FCM Notifications
        run: |
          echo "üì£ Sending FCM notifications..."

          curl -X POST https://aviders-backend-spin-1.onrender.com/api/spin/admin/run-notify \
            -H "Content-Type: application/json" \
            -H "x-internal-key: ${{ secrets.SPIN_INTERNAL_KEY }}" \
            -d '{}' \
            -w "\nHTTP Status: %{http_code}\n"

          echo "‚úÖ Notifications triggered"
