name: Daily Spin Tasks (Reset + Notify)

on:
  workflow_dispatch:   # manual trigger
  schedule:
    - cron: "30 0 * * *"   # runs daily at 00:30 UTC (~06:00 IST)

jobs:
  daily-spin-tasks:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 0Ô∏è‚É£ Wake Up Backend (if on free tier)
      # -------------------------
      - name: Wake Up Backend
        run: |
          echo "üåÖ Waking up backend (Render free tier sleeps)..."
          curl -s -o /dev/null -w "Wake-up status: %{http_code}\n" \
            https://aviders-backend-spin-1.onrender.com
          echo "Waiting 10 seconds for backend to start..."
          sleep 10

      # -------------------------
      # 1Ô∏è‚É£ Validate Secret & Backend
      # -------------------------
      - name: Validate Secret and Backend
        run: |
          echo "üîê Checking SPIN_INTERNAL_KEY..."
          if [ -z "${{ secrets.SPIN_INTERNAL_KEY }}" ]; then
            echo "‚ùå SPIN_INTERNAL_KEY not set"
            exit 1
          fi
          echo "‚úÖ Secret found"

      # -------------------------
      # 2Ô∏è‚É£ Reset Daily Free Spins (WITH RETRY)
      # -------------------------
      - name: Reset Daily Free Spins
        id: reset-spins
        run: |
          echo "üîÑ Resetting daily free spins..."
          
          # Use curl with retry for cold-start protection
          HTTP_STATUS=$(curl --retry 3 --retry-delay 5 --retry-max-time 30 \
            -X POST https://aviders-backend-spin-1.onrender.com/api/spin/admin/reset-daily \
            -H "Content-Type: application/json" \
            -H "x-internal-key: ${{ secrets.SPIN_INTERNAL_KEY }}" \
            -d '{}' \
            -w "%{http_code}" \
            -o /tmp/response.txt)
          
          RESPONSE=$(cat /tmp/response.txt)
          echo "HTTP Status: $HTTP_STATUS"
          echo "Response: $RESPONSE"
          
          # Check if successful
          if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "201" ]]; then
            echo "‚úÖ Daily spin reset completed successfully"
            echo "reset_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Daily spin reset failed with status $HTTP_STATUS"
            echo "reset_success=false" >> $GITHUB_OUTPUT
            exit 1  # Fail this step if reset doesn't work
          fi

      # -------------------------
      # 3Ô∏è‚É£ Send FCM Notifications (WITH RETRY, ONLY IF RESET SUCCEEDED)
      # -------------------------
      - name: Send FCM Notifications
        if: steps.reset-spins.outputs.reset_success == 'true'
        run: |
          echo "üì£ Sending FCM notifications..."
          
          # Use curl with retry for cold-start protection
          HTTP_STATUS=$(curl --retry 3 --retry-delay 5 --retry-max-time 30 \
            -X POST https://aviders-backend-spin-1.onrender.com/api/spin/admin/run-notify \
            -H "Content-Type: application/json" \
            -H "x-internal-key: ${{ secrets.SPIN_INTERNAL_KEY }}" \
            -d '{}' \
            -w "%{http_code}" \
            -o /tmp/notify_response.txt)
          
          RESPONSE=$(cat /tmp/notify_response.txt)
          echo "HTTP Status: $HTTP_STATUS"
          echo "Response: $RESPONSE"
          
          if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "201" ]]; then
            echo "‚úÖ Notifications triggered successfully"
          else
            echo "‚ö†Ô∏è Notifications failed with status $HTTP_STATUS (but reset was successful)"
            # Don't fail the entire workflow if notifications fail
          fi

      # -------------------------
      # 4Ô∏è‚É£ Final Status Report
      # -------------------------
      - name: Final Status
        run: |
          echo "========================================"
          echo "üìä DAILY SPIN TASK COMPLETE"
          echo "========================================"
          echo "‚úÖ Spin Reset: ${{ steps.reset-spins.outputs.reset_success || 'unknown' }}"
          echo "üì± Notifications: ${{ job.status == 'success' && 'Triggered' || 'Skipped (reset failed)' }}"
          echo ""
          echo "üïê Next run: 00:30 UTC (06:00 IST) tomorrow"
          echo "========================================"
